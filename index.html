<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Deal Map Viewer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html,body{height:100%;margin:0;padding:0}
    #map{width:100%;height:100vh}
    .loading{
      position:absolute;left:12px;top:12px;z-index:1000;
      background:#fff;padding:8px 10px;border-radius:6px;
      font-family:Arial,Helvetica,sans-serif;font-size:13px;
      box-shadow:0 2px 8px rgba(0,0,0,.18)
    }
    .filter-box{
      position:absolute;right:12px;top:12px;z-index:1000;
      background:#fff;padding:10px;border-radius:8px;
      font-family:Arial,Helvetica,sans-serif;font-size:13px;
      box-shadow:0 2px 12px rgba(0,0,0,.2);max-height:70vh;
      overflow:auto;width:260px;transition:max-height .3s ease;
    }
    .filter-box.collapsed{max-height:40px;overflow:hidden}
    .filter-toggle{
      background:#1976d2;color:#fff;border:none;padding:6px 10px;
      border-radius:4px;cursor:pointer;font-weight:bold;
    }
    .filter-toggle:hover{background:#1565c0}
    .filter-box b{display:block;margin-top:6px}
    .filter-box label{display:block;margin:4px 0;cursor:pointer}
    .hint{font-size:11px;color:#666;margin-top:8px}
    @media(max-width:640px){.filter-box{right:8px;left:8px;width:auto}}
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="loading" class="loading">Preparing map…</div>

  <div id="filters" class="filter-box">
    <button id="toggleBtn" class="filter-toggle" type="button">▼ Filters</button>
    <div id="filterContent">
      <b>Status</b><div id="statusFilters"></div>
      <b>Stage</b><div id="stageFilters"></div>
      <b>City</b><div id="cityFilters"></div>
      <b>Primary Owner</b><div id="ownerFilters"></div>
      <div class="hint">Select filters (intersection logic). Unchecked = show all.</div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
  const RAW_BASE = 'https://raw.githubusercontent.com/aditya-bd-dev/priv-data/main/';
  const DEFAULT_CENTER=[20.5937,78.9629],DEFAULT_ZOOM=5;

  const map=L.map('map').setView(DEFAULT_CENTER,DEFAULT_ZOOM);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    {maxZoom:19,attribution:'&copy; OpenStreetMap contributors'}).addTo(map);
  const loadingEl=document.getElementById('loading');
  function show(m){loadingEl.style.display='block';loadingEl.innerText=m||'Loading...';}
  function hide(){loadingEl.style.display='none';}

  let allData=null,dealLayer=null;

  // ---------- Color logic ----------
  function getStageColor(status,stage){
    const colors={
      "Active":{"Qualified Lead":"#A5D6A7","Site Visit":"#66BB6A","Prelim Offer":"#388E3C",
        "Advance Offer":"#2E7D32","Final Offer":"#1B5E20","Term Sheet":"#009688"},
      "On Hold":{"Qualified Lead":"#FFE082","Site Visit":"#FFD54F","Prelim Offer":"#FFCA28",
        "Advance Offer":"#FFC107","Final Offer":"#FFB300","Term Sheet":"#FFA000"},
      "Dropped":{"Qualified Lead":"#EF9A9A","Site Visit":"#E57373","Prelim Offer":"#EF5350",
        "Advance Offer":"#F44336","Final Offer":"#D32F2F","Term Sheet":"#B71C1C"}
    };
    return colors[status]?.[stage]||"#9E9E9E";
  }
  function colorCircle(latlng,color){
    return L.circleMarker(latlng,{radius:8,fillColor:color,color:"#333",weight:1,fillOpacity:.9});
  }

  // ---------- Filter sections ----------
  const filterSections={Status:"statusFilters",Stage:"stageFilters",City:"cityFilters",PrimaryOwner:"ownerFilters"};
  function buildFilters(){
    for(const k in filterSections){
      const container=document.getElementById(filterSections[k]);
      const vals=[...new Set(allData.features.map(f=>f.properties?.[k]).filter(Boolean))].sort();
      container.innerHTML=vals.map(v=>`<label><input type="checkbox" class="${k}-filter" value="${v}"> ${v}</label>`).join('');
    }
    document.querySelectorAll('#filterContent input').forEach(cb=>cb.onchange=updateLayer);
  }

  // ---------- Filtering ----------
  function updateLayer(){
    if(!allData)return;
    if(dealLayer){map.removeLayer(dealLayer);dealLayer=null;}
    const filters={};
    for(const k in filterSections){
      filters[k]=Array.from(document.querySelectorAll(`.${k}-filter:checked`)).map(i=>i.value);
    }
    const anyActive=Object.values(filters).some(a=>a.length>0);

    dealLayer=L.geoJSON(allData,{
      filter:f=>{
        if(!anyActive)return true;
        const p=f.properties||{};
        for(const k in filters){
          if(filters[k].length>0 && !filters[k].includes(p[k])) return false;
        }
        return true;
      },
      pointToLayer:(f,latlng)=>{
        const p=f.properties||{};
        const color=getStageColor(p.Status,p.Stage);
        return colorCircle(latlng,color);
      },
      onEachFeature:(f,layer)=>{
        const p=f.properties||{};
        const html=`<div style="font-family:Arial,Helvetica,sans-serif;font-size:13px">
          <b>Lead:</b> ${p.LeadName||''}<br/>
          <b>DealID:</b> ${p.DealID||''}<br/>
          <b>Primary Owner:</b> ${p.PrimaryOwner||''}<br/>
          <b>Status:</b> ${p.Status||''}<br/>
          <b>Stage:</b> ${p.Stage||''}<br/>
          <b>City:</b> ${p.City||''}<br/>
          <b>Land Extent:</b> ${p['Land Extent']||p.Land_Extent||''}<br/>
          <b>Lead Received On:</b> ${p.LeadReceivedOn||''}<br/>
          <b>Site Location:</b> ${p.SiteLocation||''}<br/>
          <b>Comments:</b> ${p.Comments||''}</div>`;
        layer.bindPopup(html);
      }
    }).addTo(map);
    try{
      const b=dealLayer.getBounds();
      if(b&&b.isValid()) map.fitBounds(b,{padding:[40,40],maxZoom:16});
    }catch(e){}
  }

  // ---------- Data loading ----------
  const params=new URLSearchParams(window.location.search);
  const dataParam=params.get('data'),geoParam=params.get('geo'),fileParam=params.get('file');

  async function fetchUrlText(url){const r=await fetch(url,{cache:'no-store'});if(!r.ok)throw new Error(r.status);return r.text();}
  function base64DecodeUnicode(b64){return decodeURIComponent(Array.prototype.map.call(atob(b64),c=>'%' + ('00'+c.charCodeAt(0).toString(16)).slice(-2)).join(''));}

  async function loadFromDataParam(b64){
    show('Loading embedded data...');
    let txt=b64;
    if(/^data:application\/json;base64,/.test(txt)) txt=txt.replace(/^data:application\/json;base64,/,'');
    const decoded=base64DecodeUnicode(txt);
    allData=JSON.parse(decoded);
    buildFilters();hide();updateLayer();
  }
  async function loadFromGeoParam(url){
    show('Fetching external data...');
    const txt=await fetchUrlText(decodeURIComponent(url));
    allData=JSON.parse(txt);
    buildFilters();hide();updateLayer();
  }
  async function loadFromFileParam(filename){
    show('Fetching file from GitHub raw URL...');
    const candidate=RAW_BASE+filename;
    const txt=await fetchUrlText(candidate);
    allData=JSON.parse(txt);
    buildFilters();hide();updateLayer();
  }

  (async function init(){
    show('Preparing map...');
    try{
      if(dataParam) return loadFromDataParam(dataParam);
      if(geoParam) return loadFromGeoParam(geoParam);
      if(fileParam) return loadFromFileParam(fileParam);
      await loadFromFileParam('dealdata.geojson');
    }catch(e){
      hide();
      console.error('Data load error:',e);
      alert('Unable to load data: '+e.message);
    }
  })();

  // ---------- Collapsible ----------
  const toggleBtn=document.getElementById('toggleBtn');
  const filtersBox=document.getElementById('filters');
  toggleBtn.onclick=()=>{
    filtersBox.classList.toggle('collapsed');
    toggleBtn.textContent=filtersBox.classList.contains('collapsed')?'▲ Filters':'▼ Filters';
  };
  </script>
</body>
</html>

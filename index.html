<!doctype html>
<html lang="en">
<head>
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
  <meta charset="utf-8" />
  <title>Deal Map</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #map { width: 100%; height: 100vh; }
    .legend { background: #fff; padding: 8px; border-radius: 6px; box-shadow: 0 1px 4px rgba(0,0,0,0.3); font-family: Arial, sans-serif; font-size: 13px; }
    .legend .item { display:flex; align-items:center; gap:8px; margin:6px 0; }
    .legend .marker { width:18px; height:28px; background-size:contain; background-repeat:no-repeat; display:inline-block; }
    .loading { position: absolute; left: 12px; top: 12px; z-index: 1000; background: rgba(255,255,255,0.95); padding: 6px 10px; border-radius: 4px; font-family: Arial, sans-serif; font-size: 13px; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="loading" class="loading">Loading map…</div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // -------------------------
    // Configuration
    // -------------------------
    const OWNER = 'aditya-bd-dev';
    const REPO = 'deal-map-demo';
    const DEFAULT_FILE = 'dealdata.geojson'; // single file you overwrite
    // -------------------------

    const ICONS = {
      green: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png",
      orange: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png",
      red: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png",
      shadow: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png"
    };

    function createIcon(url) {
      return L.icon({
        iconUrl: url,
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowUrl: ICONS.shadow,
        shadowSize: [41, 41]
      });
    }

    const icons = {
      Active: createIcon(ICONS.green),
      "On Hold": createIcon(ICONS.orange),
      Dropped: createIcon(ICONS.red),
      default: createIcon(ICONS.red)
    };

    // init map
    const map = L.map('map').setView([20.5937, 78.9629], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

    // legend
    const legend = L.control({ position: 'topright' });
    legend.onAdd = () => {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = '<b>Legend</b>' +
        '<div class="item"><span class="marker" style="background-image:url(' + ICONS.green + ')"></span> Active</div>' +
        '<div class="item"><span class="marker" style="background-image:url(' + ICONS.orange + ')"></span> On Hold</div>' +
        '<div class="item"><span class="marker" style="background-image:url(' + ICONS.red + ')"></span> Dropped</div>';
      return div;
    };
    legend.addTo(map);

    function hideLoading(){ const el = document.getElementById('loading'); if(el) el.style.display='none'; }
    function showLoading(msg){ const el = document.getElementById('loading'); if(el){ el.innerText = msg || 'Loading map…'; el.style.display='block'; } }

    // read ?file param optionally
    const params = new URLSearchParams(window.location.search);
    const fileParam = params.get('file'); // optional file name passed from Power Apps

    // build request URL: use relative Pages first, then fallback to raw.githubusercontent
    function buildUrls(fileName) {
      const rel = (fileName || DEFAULT_FILE) + '?t=' + Date.now(); // relative (Pages)
      const raw = 'https://raw.githubusercontent.com/' + OWNER + '/' + REPO + '/main/' + (fileName || DEFAULT_FILE) + '?t=' + Date.now(); // raw content
      return { relative: rel, raw: raw };
    }

    function fetchGeojson() {
      showLoading('Loading deal data...');
      const urls = {relative: (fileParam || DEFAULT_FILE) + '?t=' + Date.now(),
                    raw: 'https://raw.githubusercontent.com/' + OWNER + '/' + REPO + '/main/' + (fileParam || DEFAULT_FILE) + '?t=' + Date.now()
                   };
      // First try Pages-relative URL (same origin) with no-store
      fetch(urls.relative, { cache: 'no-store' })
        .then(r => {
          if (!r.ok) {
            // if 404 try raw.githubusercontent fallback
            if (r.status === 404) {
              console.warn('Pages-relative fetch 404 — trying raw.githubusercontent fallback');
              return fetch(urls.raw, { cache: 'no-store' });
            }
            throw new Error('Fetch failed: ' + r.status + ' ' + r.statusText);
          }
          return r;
        })
        .then(r2 => {
          if (!r2.ok) throw new Error('Final fetch failed: ' + r2.status + ' ' + r2.statusText);
          return r2.json();
        })
        .then(data => {
          hideLoading();
          renderGeoJson(data);
        })
        .catch(err => {
          hideLoading();
          console.error('Could not fetch deal data:', err);
          alert('Could not fetch deal data: ' + (err.message || 'unknown'));
        });
    }

    // render
    function renderGeoJson(data) {
      if (window._dealLayer) {
        try { map.removeLayer(window._dealLayer); } catch(e){ }
        window._dealLayer = null;
      }
      window._dealLayer = L.geoJSON(data, {
        pointToLayer: function(feature, latlng) {
          const status = (feature.properties && feature.properties.Status) || '';
          const icon = icons[status] || icons.default;
          return L.marker(latlng, { icon: icon });
        },
        onEachFeature: function(feature, layer) {
          const p = feature.properties || {};
          const popup = '<div style="font-family:Arial;font-size:13px">' +
            '<b>Lead:</b> ' + (p.LeadName || '') + '<br/>' +
            '<b>Owner:</b> ' + (p.PrimaryOwner || '') + '<br/>' +
            '<b>DealID:</b> ' + (p.DealID || '') + '<br/>' +
            '<b>Status:</b> ' + (p.Status || '') + '<br/>' +
            '<b>Stage:</b> ' + (p.Stage || '') + '<br/>' +
            '<b>City:</b> ' + (p.City || '') + '<br/>' +
            '<b>Site:</b> ' + (p.SiteLocation || '') + '<br/>' +
            '<b>Comments:</b> ' + (p.Comments || '') +
            '</div>';
          layer.bindPopup(popup);
        }
      }).addTo(map);

      if (window._dealLayer && window._dealLayer.getBounds && window._dealLayer.getBounds().isValid()) {
        map.fitBounds(window._dealLayer.getBounds(), { padding: [20,20] });
      } else {
        console.warn('No valid bounds from GeoJSON — keeping default view.');
      }
    }

    // start
    fetchGeojson();
  </script>
</body>
</html>



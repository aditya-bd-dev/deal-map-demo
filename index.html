<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Deal Map</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #map { width: 100%; height: 100vh; }
    .legend {
      background: #fff;
      padding: 8px;
      border-radius: 6px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.3);
      font-family: Arial, sans-serif;
      font-size: 13px;
    }
    .legend .item { display:flex; align-items:center; gap:8px; margin:6px 0; }
    .legend .marker { width:18px; height:28px; background-size:contain; background-repeat:no-repeat; display:inline-block; }
    .loading {
      position: absolute;
      left: 12px;
      top: 12px;
      z-index: 1000;
      background: rgba(255,255,255,0.9);
      padding: 6px 10px;
      border-radius: 4px;
      font-family: Arial, sans-serif;
      font-size: 13px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="loading" class="loading">Loading map…</div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // -------------------------
    // Configurable section
    // -------------------------
    const OWNER = 'aditya-bd-dev';
    const REPO = 'deal-map-demo';
    const DEFAULT_FILE = 'dealdata.geojson'; // the single file you overwrite
    const DEFAULT_INDEX = 'index.html';
    // -------------------------

    // Marker icons (public small PNGs on GitHub)
    const ICONS = {
      green: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png",
      orange: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png",
      red: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png",
      shadow: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png"
    };

    function createIcon(url) {
      return L.icon({
        iconUrl: url,
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowUrl: ICONS.shadow,
        shadowSize: [41, 41]
      });
    }

    const icons = {
      Active: createIcon(ICONS.green),
      "On Hold": createIcon(ICONS.orange),
      Dropped: createIcon(ICONS.red),
      default: createIcon(ICONS.red)
    };

    // Initialize map
    const map = L.map('map').setView([20.5937, 78.9629], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

    // Legend
    const legend = L.control({ position: 'topright' });
    legend.onAdd = () => {
      const div = L.DomUtil.create('div', 'legend');
      div.innerHTML = '<b>Legend</b>' +
        '<div class="item"><span class="marker" style="background-image:url(' + ICONS.green + ')"></span> Active</div>' +
        '<div class="item"><span class="marker" style="background-image:url(' + ICONS.orange + ')"></span> On Hold</div>' +
        '<div class="item"><span class="marker" style="background-image:url(' + ICONS.red + ')"></span> Dropped</div>';
      return div;
    };
    legend.addTo(map);

    // Show / hide loading indicator
    function hideLoading(){ const el = document.getElementById('loading'); if(el) el.style.display='none'; }
    function showLoading(msg){ const el = document.getElementById('loading'); if(el){ el.innerText = msg || 'Loading map…'; el.style.display='block'; } }

    // Determine which file to fetch:
    // Priority:
    // 1) ?file= full path or filename provided in query param (Power Apps will pass indexUrl?file=... if used)
    // 2) DEFAULT_FILE (dealdata.geojson in repo root)
    const params = new URLSearchParams(window.location.search);
    let geoParam = params.get('file'); // optional: file name or full URL
    const useGitHubApi = false; // set true if you prefer to fetch via GitHub API (not required for public Pages + cache busting)

    // Build final fetch URL:
    // If user passed a full URL (starts with http), use it; otherwise treat as relative path within site.
    function buildFetchUrl(fileParam) {
      // If full http(s) url supplied, use it (and append cache buster)
      if(!fileParam) fileParam = DEFAULT_FILE;
      if(/^https?:\/\//i.test(fileParam)) {
        return fileParam + (fileParam.indexOf('?') === -1 ? '?t=' + Date.now() : '&t=' + Date.now());
      }
      // Relative path: request from the same site (GitHub Pages root)
      return fileParam + '?t=' + Date.now();
    }

    // Primary fetch function (cache-busting)
    function fetchGeoJsonAndRender() {
      showLoading('Loading deal data…');

      // If geoParam not provided, default to DEFAULT_FILE
      const fileToFetch = geoParam || DEFAULT_FILE;
      const requestUrl = buildFetchUrl(fileToFetch);

      // Use fetch with no-store to try to avoid browser cache
      fetch(requestUrl, { cache: 'no-store' })
        .then(response => {
          if (!response.ok) {
            // If we get 404 when requesting relative path, try GitHub raw URL as fallback
            if(response.status === 404) {
              console.warn('Relative path fetch returned 404, trying raw.githubusercontent fallback.');
              // Construct raw.githubusercontent URL for repo root file (works if repo is public)
              // NOTE: this fallback assumes the file is in the repo root on the main branch.
              const rawUrl = 'https://raw.githubusercontent.com/' + OWNER + '/' + REPO + '/main/' + (geoParam || DEFAULT_FILE) + '?t=' + Date.now();
              return fetch(rawUrl, { cache: 'no-store' });
            }
            throw new Error('Fetch failed: ' + response.status + ' ' + response.statusText);
          }
          return response;
        })
        .then(resp => {
          if(!resp.ok) throw new Error('Final fetch failed: ' + resp.status + ' ' + resp.statusText);
          return resp.json();
        })
        .then(data => {
          hideLoading();
          renderGeoJson(data);
        })
        .catch(err => {
          hideLoading();
          console.error('Error loading dealdata.geojson:', err);
          alert('Could not load deal data: ' + err.message);
        });
    }

    // Render GeoJSON into the map
    function renderGeoJson(data) {
      // Remove any existing GeoJSON layers (simple approach)
      if (window._dealLayer) {
        try { map.removeLayer(window._dealLayer); } catch (e) { /* ignore */ }
        window._dealLayer = null;
      }

      window._dealLayer = L.geoJSON(data, {
        pointToLayer: function(feature, latlng) {
          const status = (feature.properties && feature.properties.Status) || '';
          const icon = icons[status] || icons.default;
          return L.marker(latlng, { icon: icon });
        },
        onEachFeature: function(feature, layer) {
          const p = feature.properties || {};
          const popup = '<div style="font-family:Arial;font-size:13px">' +
            '<b>Lead:</b> ' + (p.LeadName || '') + '<br/>' +
            '<b>Owner:</b> ' + (p.PrimaryOwner || '') + '<br/>' +
            '<b>DealID:</b> ' + (p.DealID || '') + '<br/>' +
            '<b>Status:</b> ' + (p.Status || '') + '<br/>' +
            '<b>Stage:</b> ' + (p.Stage || '') + '<br/>' +
            '<b>City:</b> ' + (p.City || '') + '<br/>' +
            '<b>Site:</b> ' + (p.SiteLocation || '') + '<br/>' +
            '<b>Comments:</b> ' + (p.Comments || '') +
            '</div>';
          layer.bindPopup(popup);
        }
      }).addTo(map);

      // Fit bounds if possible
      if (window._dealLayer && window._dealLayer.getBounds && window._dealLayer.getBounds().isValid()) {
        map.fitBounds(window._dealLayer.getBounds(), { padding: [20,20] });
      } else {
        // no valid bounds — keep default view
        console.warn('GeoJSON had no valid bounds; keeping default map view.');
      }
    }

    // Kick off fetch & render
    fetchGeoJsonAndRender();
  </script>
</body>
</html>

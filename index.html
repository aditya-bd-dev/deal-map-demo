<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Deal Map</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html,body{height:100%;margin:0;padding:0;font-family:Arial, Helvetica, sans-serif}
    #map{width:100%;height:100vh}
    .loading{position:absolute;left:12px;top:12px;z-index:1000;background:#fff;padding:8px 12px;border-radius:6px;font-size:13px;box-shadow:0 2px 8px rgba(0,0,0,.12)}
    .filter-box{position:absolute;right:12px;top:12px;z-index:1000;background:#fff;padding:10px;border-radius:8px;font-size:13px;box-shadow:0 2px 12px rgba(0,0,0,.14);max-height:72vh;overflow:auto;width:240px}
    .filter-box b{display:block;margin-top:6px}
    .filter-box label{display:block;margin:6px 0;cursor:pointer}
    .muted{font-size:12px;color:#666;margin-top:8px}
    .error{color:#a00;font-weight:600}
  </style>
</head>
<body>
  <div id="map"></div>

  <div id="loading" class="loading">Preparing map…</div>

  <div id="filters" class="filter-box" aria-hidden="false">
    <b>Status</b>
    <label><input type="checkbox" class="status-filter" value="Active"> Active</label>
    <label><input type="checkbox" class="status-filter" value="On Hold"> On Hold</label>
    <label><input type="checkbox" class="status-filter" value="Dropped"> Dropped</label>

    <b>Stage</b>
    <label><input type="checkbox" class="stage-filter" value="Qualified Lead"> Qualified Lead</label>
    <label><input type="checkbox" class="stage-filter" value="Site Visit"> Site Visit</label>
    <label><input type="checkbox" class="stage-filter" value="Prelim Offer"> Prelim Offer</label>
    <label><input type="checkbox" class="stage-filter" value="Advance Offer"> Advance Offer</label>
    <label><input type="checkbox" class="stage-filter" value="Final Offer"> Final Offer</label>
    <label><input type="checkbox" class="stage-filter" value="Term Sheet"> Term Sheet</label>

    <div class="muted">Tip: all boxes start <strong>unchecked</strong> and map initially shows all deals. Check boxes to filter.</div>
    <div id="statusMsg" class="muted"></div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // ---------- CONFIG ----------
    const ICONS = {
      green: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png",
      orange: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png",
      red: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png",
      shadow: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png"
    };

    function makeIcon(url){ return L.icon({ iconUrl: url, iconSize: [25,41], iconAnchor: [12,41], popupAnchor: [1,-34], shadowUrl: ICONS.shadow, shadowSize: [41,41] }); }
    const ICON_MAP = { Active: makeIcon(ICONS.green), "On Hold": makeIcon(ICONS.orange), Dropped: makeIcon(ICONS.red), default: makeIcon(ICONS.red) };
    // ----------------------------

    const map = L.map('map').setView([20.5937,78.9629], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

    const loadingEl = document.getElementById('loading');
    const statusMsgEl = document.getElementById('statusMsg');
    function showLoading(text){ loadingEl.style.display = 'block'; loadingEl.innerText = text || 'Loading...'; }
    function hideLoading(){ loadingEl.style.display = 'none'; }
    function setStatus(text, isError){ statusMsgEl.innerText = text || ''; statusMsgEl.className = isError ? 'error' : 'muted'; }

    let allData = null;
    let geoLayer = null;

    // read params: prefer geo, fallback to file
    const params = new URLSearchParams(window.location.search);
    let geoParam = params.get('geo') || params.get('file') || null;
    // If power automate encoded the URL twice, it will be percent-encoded; we decode here
    if (geoParam) {
      try { geoParam = decodeURIComponent(geoParam); } catch(e) { /* ignore */ }
    }

    // fetch helper: handle viewer HTML vs JSON, credentials include for org links
    async function fetchGeoJson(url) {
      showLoading('Fetching deal data...');
      setStatus('');
      try {
        // try fetch with credentials included (for org-scoped links)
        const resp = await fetch(url, { cache: 'no-store', credentials: 'include' });
        if (!resp.ok) {
          throw new Error(resp.status + ' ' + resp.statusText);
        }
        const text = await resp.text();
        // detect HTML viewer page (SharePoint viewer) - don't try to parse HTML
        if (/^\s*<\s*html/i.test(text) || /<\s*div[^>]*id="?sp-/.test(text) ) {
          // return helpful message
          throw new Error('Received HTML (SharePoint viewer page) instead of raw GeoJSON. Ensure Flow returned a direct download URL (download.aspx) or that the user is signed in.');
        }
        // parse JSON
        const json = JSON.parse(text);
        return json;
      } catch (err) {
        throw err;
      } finally {
        hideLoading();
      }
    }

    // filters wiring: ensure all checkboxes start unchecked but map shows all deals
    function attachFilterHandlers() {
      const inputs = document.querySelectorAll('.filter-box input');
      inputs.forEach(i => {
        try { i.checked = false; } catch(e) {}
        i.onchange = updateLayer;
      });
    }

    // update visible layer according to union of checked statuses/stages
    function updateLayer() {
      if (!allData) return;
      if (geoLayer) { try { map.removeLayer(geoLayer); } catch(e) {} geoLayer = null; }

      const statusChecked = Array.from(document.querySelectorAll('.status-filter:checked')).map(i=>i.value);
      const stageChecked = Array.from(document.querySelectorAll('.stage-filter:checked')).map(i=>i.value);
      const anyChecked = statusChecked.length > 0 || stageChecked.length > 0;

      geoLayer = L.geoJSON(allData, {
        filter: function(feature) {
          if (!anyChecked) return true; // show all when nothing checked
          const p = feature.properties || {};
          const s = p.Status || '';
          const st = p.Stage || '';
          const matchStatus = statusChecked.length>0 && statusChecked.includes(s);
          const matchStage = stageChecked.length>0 && stageChecked.includes(st);
          return matchStatus || matchStage; // union
        },
        pointToLayer: function(feature, latlng) {
          const p = feature.properties || {};
          const s = p.Status || '';
          return L.marker(latlng, { icon: ICON_MAP[s] || ICON_MAP.default });
        },
        onEachFeature: function(feature, layer) {
          const p = feature.properties || {};
          const html = '<div style="font-size:13px">' +
            '<b>Lead:</b> ' + (p.LeadName||'') + '<br/>' +
            '<b>DealID:</b> ' + (p.DealID||'') + '<br/>' +
            '<b>Owner:</b> ' + (p.PrimaryOwner||'') + '<br/>' +
            '<b>Status:</b> ' + (p.Status||'') + '<br/>' +
            '<b>Stage:</b> ' + (p.Stage||'') + '<br/>' +
            '<b>City:</b> ' + (p.City||'') + '<br/>' +
            '<b>Land Extent:</b> ' + (p['Land Extent']||p.LandExtent||'') + '<br/>' +
            '<b>LeadReceivedOn:</b> ' + (p.LeadReceivedOn||'') + '<br/>' +
            '<b>Site:</b> ' + (p.SiteLocation||'') + '<br/>' +
            '<b>Comments:</b> ' + (p.Comments||'') +
            '</div>';
          layer.bindPopup(html);
        }
      }).addTo(map);

      // center/zoom nicely if there are points
      try {
        const bounds = geoLayer.getBounds();
        if (bounds && bounds.isValid()) {
          map.fitBounds(bounds, { padding: [30,30] });
        }
      } catch(e) { console.warn('fitBounds failed', e); }
    }

    // main startup
    (async function init() {
      attachFilterHandlers();
      showLoading('Preparing map…');

      // if geoParam provided, use it
      if (geoParam) {
        setStatus('Using geo/file parameter from URL');
        try {
          const data = await fetchGeoJson(geoParam);
          allData = data;
          setStatus('Loaded ' + (data.features ? data.features.length : 'unknown') + ' features');
          updateLayer();
          return;
        } catch (err) {
          console.error('fetchGeoJson failed for geoParam', err);
          setStatus('Could not fetch deal data: ' + err.message, true);
          alert('Could not fetch deal data: ' + err.message + '\n\nIf this is an org-scoped SharePoint URL, please ensure you are logged into SharePoint in this browser.');
          return;
        }
      }

      // fallback: try relative file name (if index.html and geojson are co-located)
      const fallback = 'dealdata.geojson?t=' + Date.now();
      setStatus('No geo param found; attempting fallback: ' + fallback);
      try {
        const data = await fetchGeoJson(fallback);
        allData = data;
        setStatus('Loaded ' + (data.features ? data.features.length : 'unknown') + ' features');
        updateLayer();
        return;
      } catch (err) {
        console.error('fallback fetch failed', err);
        setStatus('Could not fetch dealdata.geojson. Provide the geo parameter in the URL pointing to a SharePoint download URL.', true);
        alert('Could not fetch dealdata.geojson. Provide the geo parameter in the URL pointing to a SharePoint download URL.\n\nDetails: ' + err.message);
      }
    })();

    // debug helper (optional)
    window.__refresh = function() { location.reload(); };
  </script>
</body>
</html>

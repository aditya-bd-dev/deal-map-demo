<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Deal Map (Live)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html,body { height:100%; margin:0; padding:0; }
    #map { width:100%; height:100vh; }
    .legend { background:#fff; padding:8px; border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,.25); font-family:Arial, sans-serif; font-size:13px; }
    .legend .item { display:flex; align-items:center; gap:8px; margin:6px 0; }
    .legend .marker { width:18px; height:28px; background-size:contain; background-repeat:no-repeat; display:inline-block; }
    .loading { position:absolute; left:12px; top:12px; z-index:1000; background:rgba(255,255,255,0.95); padding:6px 10px; border-radius:4px; font-family:Arial, sans-serif; font-size:13px; box-shadow:0 1px 3px rgba(0,0,0,0.15); }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="loading" class="loading">Loading map…</div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // ---------------- CONFIG ----------------
    const OWNER = 'aditya-bd-dev';          // your github user/org
    const REPO = 'deal-map-demo';           // your repo
    const BRANCH = 'main';                  // branch to read raw file from
    const DEFAULT_FILE = 'dealdata.geojson';// the file your flow overwrites
    // ----------------------------------------

    // Marker icon URLs (public)
    const ICONS = {
      green: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png",
      orange: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png",
      red: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png",
      shadow: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png"
    };

    function createIcon(url) {
      return L.icon({
        iconUrl: url,
        iconSize: [25,41],
        iconAnchor: [12,41],
        popupAnchor: [1,-34],
        shadowUrl: ICONS.shadow,
        shadowSize: [41,41]
      });
    }

    const icons = {
      Active: createIcon(ICONS.green),
      "On Hold": createIcon(ICONS.orange),
      Dropped: createIcon(ICONS.red),
      default: createIcon(ICONS.red)
    };

    // init map
    const map = L.map('map').setView([20.5937,78.9629],5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19 }).addTo(map);

    // legend
    const legend = L.control({ position:'topright' });
    legend.onAdd = () => {
      const d = L.DomUtil.create('div','legend');
      d.innerHTML = '<b>Legend</b>' +
        '<div class="item"><span class="marker" style="background-image:url(' + ICONS.green + ')"></span> Active</div>' +
        '<div class="item"><span class="marker" style="background-image:url(' + ICONS.orange + ')"></span> On Hold</div>' +
        '<div class="item"><span class="marker" style="background-image:url(' + ICONS.red + ')"></span> Dropped</div>';
      return d;
    };
    legend.addTo(map);

    function showLoading(msg){ const e=document.getElementById('loading'); if(e){ e.innerText = msg||'Loading map…'; e.style.display='block'; } }
    function hideLoading(){ const e=document.getElementById('loading'); if(e) e.style.display='none'; }

    // Accept ?file= param (full URL or filename). If none -> default file.
    const params = new URLSearchParams(window.location.search);
    const fileParam = params.get('file'); // optional: either full URL or just filename (eg: dealdata_...)

    // Build the final raw.githubusercontent URL (guarantees latest content)
    function buildRawUrl(fileNameOrFullUrl) {
      // if user passed absolute URL, use that
      if (fileNameOrFullUrl && /^https?:\/\//i.test(fileNameOrFullUrl)) {
        // append cachebust param
        return fileNameOrFullUrl + (fileNameOrFullUrl.indexOf('?') === -1 ? '?t=' + Date.now() : '&t=' + Date.now());
      }
      // otherwise construct raw.githubusercontent url for repo root
      const fname = (fileNameOrFullUrl || DEFAULT_FILE);
      return 'https://raw.githubusercontent.com/' + OWNER + '/' + REPO + '/' + BRANCH + '/' + fname + '?t=' + Date.now();
    }

    // fetch and render geojson (raw.githubusercontent ensures latest file)
    function fetchAndRender() {
      showLoading('Loading latest deal data...');
      const url = buildRawUrl(fileParam);

      fetch(url, { cache: 'no-store' })
        .then(resp => {
          if (!resp.ok) throw new Error('Fetch failed: ' + resp.status + ' ' + resp.statusText);
          return resp.json();
        })
        .then(data => {
          hideLoading();
          renderGeoJSON(data);
        })
        .catch(err => {
          hideLoading();
          console.error('Could not fetch deal data:', err);
          alert('Could not fetch deal data: ' + (err.message || 'unknown'));
        });
    }

    // render GeoJSON on map
    function renderGeoJSON(data) {
      try {
        if (window._dealLayer) { map.removeLayer(window._dealLayer); window._dealLayer = null; }
      } catch(e){ /* ignore */ }

      window._dealLayer = L.geoJSON(data, {
        pointToLayer: function(feature, latlng) {
          const status = (feature.properties && feature.properties.Status) || '';
          const icon = icons[status] || icons.default;
          return L.marker(latlng, { icon: icon });
        },
        onEachFeature: function(feature, layer) {
          const p = feature.properties || {};
          const popup = '<div style="font-family:Arial;font-size:13px">' +
            '<b>Lead:</b> ' + (p.LeadName || '') + '<br/>' +
            '<b>Owner:</b> ' + (p.PrimaryOwner || '') + '<br/>' +
            '<b>DealID:</b> ' + (p.DealID || '') + '<br/>' +
            '<b>Status:</b> ' + (p.Status || '') + '<br/>' +
            '<b>Stage:</b> ' + (p.Stage || '') + '<br/>' +
            '<b>City:</b> ' + (p.City || '') + '<br/>' +
            '<b>Site:</b> ' + (p.SiteLocation || '') + '<br/>' +
            '<b>Comments:</b> ' + (p.Comments || '') +
            '</div>';
          layer.bindPopup(popup);
        }
      }).addTo(map);

      if (window._dealLayer && window._dealLayer.getBounds && window._dealLayer.getBounds().isValid()) {
        map.fitBounds(window._dealLayer.getBounds(), { padding: [20,20] });
      } else {
        console.warn('No valid bounds from GeoJSON; keeping default view.');
      }
    }

    // Kick off
    fetchAndRender();

    // Optional: expose a refresh function for debugging / manual reloads
    window.refreshDealMap = function(){ fetchAndRender(); };
  </script>
</body>
</html>

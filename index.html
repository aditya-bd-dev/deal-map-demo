<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Deal Map</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html,body{height:100%;margin:0;padding:0}
    #map{width:100%;height:100vh}
    .loading{position:absolute;left:12px;top:12px;z-index:1000;background:#fff;padding:6px 10px;border-radius:4px; font-family:Arial;font-size:13px;box-shadow:0 1px 3px rgba(0,0,0,.2)}
    .filter-box{position:absolute;right:12px;top:12px;z-index:1000;background:#fff;padding:10px;border-radius:6px;font-family:Arial;font-size:13px;box-shadow:0 1px 6px rgba(0,0,0,.25);max-height:70vh;overflow:auto;width:220px}
    .filter-box b{display:block;margin-top:6px}
    .filter-box label{display:block;margin:3px 0;cursor:pointer}
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="loading" class="loading">Preparing map…</div>
  <div id="filters" class="filter-box" aria-hidden="false">
    <b>Status</b>
    <label><input type="checkbox" class="status-filter" value="Active" autocomplete="off"> Active</label>
    <label><input type="checkbox" class="status-filter" value="On Hold" autocomplete="off"> On Hold</label>
    <label><input type="checkbox" class="status-filter" value="Dropped" autocomplete="off"> Dropped</label>

    <b>Stage</b>
    <label><input type="checkbox" class="stage-filter" value="Qualified Lead" autocomplete="off"> Qualified Lead</label>
    <label><input type="checkbox" class="stage-filter" value="Site Visit" autocomplete="off"> Site Visit</label>
    <label><input type="checkbox" class="stage-filter" value="Prelim Offer" autocomplete="off"> Prelim Offer</label>
    <label><input type="checkbox" class="stage-filter" value="Advance Offer" autocomplete="off"> Advance Offer</label>
    <label><input type="checkbox" class="stage-filter" value="Final Offer" autocomplete="off"> Final Offer</label>
    <label><input type="checkbox" class="stage-filter" value="Term Sheet" autocomplete="off"> Term Sheet</label>

    <div style="font-size:11px;color:#666;margin-top:6px">
      Tip: check boxes to filter. All start unchecked → map initially shows all deals.
    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // ----- CONFIG -----
    const ICONS = {
      green: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png",
      orange: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png",
      red: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png",
      shadow: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png"
    };
    function makeIcon(url){ return L.icon({ iconUrl:url, iconSize:[25,41], iconAnchor:[12,41], popupAnchor:[1,-34], shadowUrl:ICONS.shadow, shadowSize:[41,41] }); }
    const ICON_MAP = { Active: makeIcon(ICONS.green), "On Hold": makeIcon(ICONS.orange), Dropped: makeIcon(ICONS.red), default: makeIcon(ICONS.red) };
    // -------------------

    const map = L.map('map').setView([20.5937,78.9629],5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

    const loading = document.getElementById('loading');
    function show(msg){ loading.style.display='block'; loading.innerText = msg || 'Loading...'; }
    function hide(){ loading.style.display='none'; }

    let allData = null, dealLayer = null;

    // Read geo param
    const params = new URLSearchParams(window.location.search);
    const geoParam = params.get('geo'); // expected to be an encoded download URL from SharePoint

    // Ensure checkboxes are unchecked on load
    function attachFilters(){
      document.querySelectorAll('.filter-box input').forEach(cb => { try{ cb.checked = false } catch(e){} cb.onchange = updateLayer; });
    }

    function updateLayer(){
      if(!allData) return;
      if(dealLayer){ try{ map.removeLayer(dealLayer); }catch(e){} dealLayer = null; }

      const statusChecked = Array.from(document.querySelectorAll('.status-filter:checked')).map(i=>i.value);
      const stageChecked = Array.from(document.querySelectorAll('.stage-filter:checked')).map(i=>i.value);
      const anyChecked = statusChecked.length > 0 || stageChecked.length > 0;

      dealLayer = L.geoJSON(allData, {
        filter: function(f){
          if(!anyChecked) return true;
          const s = (f.properties && f.properties.Status) || '';
          const st = (f.properties && f.properties.Stage) || '';
          return (statusChecked.includes(s) || stageChecked.includes(st));
        },
        pointToLayer: function(f, latlng){ const s = (f.properties && f.properties.Status) || ''; return L.marker(latlng, { icon: ICON_MAP[s] || ICON_MAP.default }); },
        onEachFeature: function(f, layer){
          const p = f.properties || {};
          const html = '<div style="font-family:Arial;font-size:13px">' +
            '<b>Lead:</b> '+(p.LeadName||'')+'<br/>' +
            '<b>DealID:</b> '+(p.DealID||'')+'<br/>' +
            '<b>Owner:</b> '+(p.PrimaryOwner||'')+'<br/>' +
            '<b>Status:</b> '+(p.Status||'')+'<br/>' +
            '<b>Stage:</b> '+(p.Stage||'')+'<br/>' +
            '<b>City:</b> '+(p.City||'')+'<br/>' +
            '<b>Site:</b> '+(p.SiteLocation||'')+'<br/>' +
            '<b>Comments:</b> '+(p.Comments||'') +
            '</div>';
          layer.bindPopup(html);
        }
      }).addTo(map);

      try{ if(dealLayer.getBounds && dealLayer.getBounds().isValid()) map.fitBounds(dealLayer.getBounds(),{padding:[20,20]}); } catch(e){}
    }

    async function fetchGeo(url){
      show('Fetching data…');
      try{
        const r = await fetch(url, { cache:'no-store', credentials: 'include' });
        if(!r.ok) throw new Error('HTTP ' + r.status + ' ' + r.statusText);
        const txt = await r.text();
        // if the response looks like HTML (SharePoint viewer), throw to surface error
        if(/<\s*html/i.test(txt)) throw new Error('Received HTML instead of JSON (viewer page). Ensure Flow returned a direct download URL.');
        const json = JSON.parse(txt);
        return json;
      }catch(err){
        throw err;
      }finally{
        hide();
      }
    }

    (async function init(){
      attachFilters();
      // 1) If flow passed a geo param (download url) - use it
      if(geoParam){
        const geoUrl = decodeURIComponent(geoParam);
        try{
          allData = await fetchGeo(geoUrl);
          updateLayer();
          return;
        }catch(err){
          console.error('Fetch via geo param failed:',err);
          alert('Could not fetch data from SharePoint URL passed by the app. Error: ' + err.message);
          return;
        }
      }

      // 2) fallback - try relative file (if you're serving index.html and geo in same folder)
      const fallback = 'dealdata.geojson?t=' + Date.now();
      try{
        allData = await fetchGeo(fallback);
        updateLayer();
        return;
      }catch(err){
        console.error('Fallback fetch failed', err);
        alert('Could not fetch dealdata.geojson. Provide the geo parameter in the URL pointing to a SharePoint download URL.');
      }
    })();

  </script>
</body>
</html>

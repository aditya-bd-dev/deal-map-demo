<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Deal Map</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { height:100%; margin:0; padding:0; }
    #map { width:100%; height:100vh; }

    .loading {
      position:absolute;
      left:12px; top:12px;
      z-index:1000;
      background:#fff;
      padding:6px 10px;
      border-radius:4px;
      font-family:Arial;
      font-size:13px;
      box-shadow:0 1px 3px rgba(0,0,0,.2);
    }

    .filter-box {
      background:#fff;
      padding:8px 10px;
      border-radius:6px;
      font-family:Arial, sans-serif;
      font-size:13px;
      box-shadow:0 1px 4px rgba(0,0,0,.25);
      max-height:320px;
      overflow-y:auto;
    }
    .filter-box b { display:block; margin-top:6px; }
    .filter-box label { display:block; margin:3px 0; cursor:pointer; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="loading" class="loading">Loading mapâ€¦</div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const OWNER = 'aditya-bd-dev';
    const REPO = 'deal-map-demo';
    const BRANCH = 'main';

    // Marker icons
    const ICONS = {
      green: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png",
      orange: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png",
      red: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png",
      shadow: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png"
    };
    function createIcon(url){
      return L.icon({
        iconUrl:url, iconSize:[25,41], iconAnchor:[12,41],
        popupAnchor:[1,-34], shadowUrl:ICONS.shadow, shadowSize:[41,41]
      });
    }
    const icons = {
      Active:createIcon(ICONS.green),
      "On Hold":createIcon(ICONS.orange),
      Dropped:createIcon(ICONS.red),
      default:createIcon(ICONS.red)
    };

    // Map setup
    const map = L.map('map').setView([20.5937,78.9629],5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

    // Build and add filter control (checkboxes start UNCHECKED)
    const filterControl = L.control({ position:'topright' });
    filterControl.onAdd = function() {
      const div = L.DomUtil.create('div','filter-box');
      div.innerHTML = `
        <b>Status</b>
        <label><input type="checkbox" class="status-filter" value="Active"> Active</label>
        <label><input type="checkbox" class="status-filter" value="On Hold"> On Hold</label>
        <label><input type="checkbox" class="status-filter" value="Dropped"> Dropped</label>

        <b>Stage</b>
        <label><input type="checkbox" class="stage-filter" value="Qualified Lead"> Qualified Lead</label>
        <label><input type="checkbox" class="stage-filter" value="Site Visit"> Site Visit</label>
        <label><input type="checkbox" class="stage-filter" value="Prelim Offer"> Prelim Offer</label>
        <label><input type="checkbox" class="stage-filter" value="Advance Offer"> Advance Offer</label>
        <label><input type="checkbox" class="stage-filter" value="Final Offer"> Final Offer</label>
        <label><input type="checkbox" class="stage-filter" value="Term Sheet"> Term Sheet</label>
      `;
      return div;
    };
    filterControl.addTo(map);

    // Show/hide loading
    function show(msg){ const e=document.getElementById('loading'); if(e){ e.innerText=msg; e.style.display='block'; } }
    function hide(){ const e=document.getElementById('loading'); if(e) e.style.display='none'; }

    // Data variables
    let allData = null;
    let dealLayer = null;

    // Filtering behavior:
    // - If NO checkboxes checked (both status AND stage arrays empty) => show ALL deals.
    // - If any checkbox checked (status or stage), show deals that match ANY checked status OR ANY checked stage (union).
    function updateLayer() {
      if (!allData) return;
      if (dealLayer) { map.removeLayer(dealLayer); }

      const statusChecked = Array.from(document.querySelectorAll('.status-filter:checked')).map(cb => cb.value);
      const stageChecked = Array.from(document.querySelectorAll('.stage-filter:checked')).map(cb => cb.value);

      const anyFilterChecked = (statusChecked.length > 0) || (stageChecked.length > 0);

      dealLayer = L.geoJSON(allData, {
        filter: (feature) => {
          if (!anyFilterChecked) return true; // no filters selected -> show everything

          const s = (feature.properties && feature.properties.Status) || '';
          const st = (feature.properties && feature.properties.Stage) || '';

          // show if matches any selected status OR any selected stage
          const matchStatus = statusChecked.length > 0 && statusChecked.includes(s);
          const matchStage = stageChecked.length > 0 && stageChecked.includes(st);

          return matchStatus || matchStage;
        },
        pointToLayer: (f,latlng) => {
          const s = (f.properties && f.properties.Status) || '';
          return L.marker(latlng,{ icon: icons[s]||icons.default });
        },
        onEachFeature: (f,layer) => {
          const p = f.properties||{};
          const html = '<div style="font-family:Arial;font-size:13px">' +
            '<b>Lead:</b> '+(p.LeadName||'')+'<br/>' +
            '<b>Owner:</b> '+(p.PrimaryOwner||'')+'<br/>' +
            '<b>DealID:</b> '+(p.DealID||'')+'<br/>' +
            '<b>Status:</b> '+(p.Status||'')+'<br/>' +
            '<b>Stage:</b> '+(p.Stage||'')+'<br/>' +
            '<b>City:</b> '+(p.City||'')+'<br/>' +
            '<b>Site:</b> '+(p.SiteLocation||'')+'<br/>' +
            '<b>Comments:</b> '+(p.Comments||'') +
            '</div>';
          layer.bindPopup(html);
        }
      }).addTo(map);

      if (dealLayer.getBounds && dealLayer.getBounds().isValid()) {
        map.fitBounds(dealLayer.getBounds(), { padding:[20,20] });
      }
    }

    // Attach checkbox listeners
    function attachFilterListeners() {
      const inputs = document.querySelectorAll('.filter-box input');
      inputs.forEach(cb => {
        cb.onchange = updateLayer;
      });
    }

    // Fetch data (from raw.githubusercontent to avoid Pages caching)
    const params = new URLSearchParams(window.location.search);
    const fileParam = params.get('file'); // optional filename passed by Power Apps flow (versioned), else default
    const fileName = fileParam || 'dealdata.geojson';
    const url = 'https://raw.githubusercontent.com/' + OWNER + '/' + REPO + '/' + BRANCH + '/' + fileName + '?t=' + Date.now();

    show('Fetching ' + fileName + ' ...');
    fetch(url, { cache:'no-store' })
      .then(r => { if(!r.ok) throw new Error(r.status+' '+r.statusText); return r.json(); })
      .then(data => {
        hide();
        allData = data;
        // ensure controls have listeners (DOM for control exists now)
        // small timeout to let Leaflet attach control DOM
        setTimeout(() => {
          attachFilterListeners();
          updateLayer(); // initial render (no checkboxes checked -> show all)
        }, 50);
      })
      .catch(err => { hide(); alert('Could not fetch '+fileName+': '+err.message); console.error(err); });
  </script>
</body>
</html>
